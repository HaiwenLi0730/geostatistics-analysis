---
title: "STATS C173 Course Project"
author: "Haiwen Li"
date: "3/16/2021"
output: pdf_document
---

## 1. Data Introduction
This project focuses on a geostatistical dataset called ussoils. The original source of this dataset is "Chemical analyses of soils and other surficial materials of the conterminous United States"(https://catalog.data.gov/dataset/chemical-analyses-of-soils-and-other-surficial-materials-of-the-conterminous-united-states). It is collected by Hans Shacklette.

In this dataset, surficial soil samples are collected at a depth of about 20 centimeters from sites. They contain chemical substances in its natural conditions. The analysis of this dataset is meaningful because the concentrations of surficial chemical elements as well as their spatial location information could help people to better measure the soil quality.

Ussoils dataset contains 500 observations, each representing the result of a soil sample. All the observations have 7 variables. "State" variable indicates state information; "Latitude" and "Longitude" variables describe the exact location of every soil sample. "Ba_ppm", "Cu_ppm", "Zr_ppm", "Se_ppm" represent the amount of barium, copper, zirconium, and selenium in ppm (miligrams per liter) contained in the soil sample.  

The rest of the project report is organized as follows. First, a non-spatial exploratory analysis is introduced to give an overview of some important information contained in the dataset. Next, a spatial analysis based on variograms is presented. Then, spatial predictions by kriging are performed. Finally, conclusion and comments are made.  
```{r,include=F}
library(tidyverse)
library(geoR)
library(gstat)
library(sp)
library(maps)
ussoils <- read_csv("soils.csv")
```


## 2. None-Spatial Exploratory Analysis
In this project, variable "Se_ppm" is the response variable while the rest of numeric variables are explanatory variables, so the following non-spatial exploratory analysis mainly focuses on Se_ppm.  

### 2.1 Histograms, Boxplots, and Empirical CDF
Boxplot, histogram, and ecdf help us to understand the distributions. The boxplot and histogram below visualize the overall distribution of variable Se_ppm. Both graphs are highly right skewed, which means the mass of the distribution is concentrated on the left/bottom of the figures and the majority of the values is less than the mean. Empirical cumulative distribution function(ecdf) is an estimate of the cumulative distribution function that generates the points in this sample. The ecdf figure below shows that the line converges to probability 1 as Se_ppm approximates 2. Besides, a theoretical cumulative normal distribution using the mean and standard deviation of observed Se_ppm is added in the graph. These two lines barely overlap, verifying the distribution of Se_ppm may not be approximated with a normal distribution.  

```{r,echo=FALSE}
par(mfrow=c(1,3))
boxplot(ussoils$Se_ppm, main = "Boxplot of Se_ppm")
hist(ussoils$Se_ppm, xlab = "Se_ppm",main = "Histogram of Se_ppm")
plot(ecdf(ussoils$Se_ppm), xlab = "Se_ppm", ylab = "Cumulative Probability", 
     main = "Empirical Cumulative Distribution of Se_ppm")
curve(pnorm(x,mean(ussoils$Se_ppm),sd(ussoils$Se_ppm)),-1, 4, add=T, col =2)
grid(NULL,NULL)
legend("bottomright",legend=c("ecdf","normal cdf"),col=1:2,lty=1,cex=1,box.lty = 0)
```


### 2.2 Transformation
2.1 shows that Se_ppm is a highly skewed variable. Therefore a logarithmic transformation is implemented on Se_ppm to normalize it. A new variable log_Se is created, and the following graphs are the boxplot, histogram, and ecdf of log_Se. Compared to Se_ppm, log_Se has been improved a lot.  

```{r,echo=FALSE}
par(mfrow=c(1,3))
log_Se <- log(ussoils$Se_ppm)
boxplot(log_Se, main = "Boxplot of log_Se")
hist(log_Se,freq = F, xlab = "log_Se",main = "Histogram of log_Se")
lines(density(log_Se))
plot(ecdf(log_Se),xlab = "log_Se", ylab = "Cumulative Probability", 
     main = "ECDF of log_Se")
curve(pnorm(x,mean(log_Se),sd(log_Se)),-3, 2, add=T, col=2)
grid(NULL,NULL)
legend("bottomright",legend=c("ecdf","normal cdf"),col=1:2,lty=1,cex=1,box.lty = 0)
```


### 2.3 Trend
To understand if there exist some trends in the north-south or east-west directions, log_Se is plotted against longitude and latitude separately. The scatterplots below indicate no (very weak) trend in the data.  

```{r,echo=FALSE}
par(mfrow=c(1,2))
plot(ussoils$Longitude,log_Se,xlab="Longitude",ylab = "log_Se", 
     main="Plot of log_Se against Longitude")
abline(lm(log_Se~Longitude,data=ussoils),col="red")
plot(ussoils$Latitude,log_Se,xlab="Latitude",ylab = "log_Se", 
     main="Plot of log_Se against Latitude")
abline(lm(log_Se~Latitude,data=ussoils),col="red")
```


## 3. Spatial Analysis
In this section, h-scatterplots and variograms are used to better understand spatial correlation.   

### 3.1 h-Scatterplot
The following h-scatterplots are produced by gstat package. We measure the "fatness" of points in the h-scatterplots by the correlation coefficient. Although the correlation coefficients are small, they still have a decreasing trend as the separation distance increases.  

```{r,echo=FALSE}
hscat<-cbind(ussoils[,c(2,3)],log_Se)
coordinates(hscat) <- ~Longitude+Latitude 
hscat(log_Se~1,hscat, seq(0,3,0.5)) 
```


### 3.2 Variogram Analysis
The following variogram analysis is based on geoR package. Here is a bubble plot of log_Se on the map.  
```{r,echo=FALSE}
plot(ussoils$Longitude,ussoils$Latitude, xlim=c(-125,-65),ylim=c(25,50), xlab="Longitude",
     ylab="Latitude", main="Log_Selemium Concentration in the United States", "n")
map("usa",add=TRUE)
points(ussoils$Longitude,ussoils$Latitude, 
       cex=log_Se/mean(log_Se),pch=19,col="orange")
```

Empirical variograms with maximum distance of 20 are generated. The following empirical variograms are omnidirectional semivariograms using classical estimator and robust estimator. Variogram clouds and boxplots are also constructed and compared. The plots show that robust estimator is better at dealing outliers compared to classical estimators. Cross validation will be later used in the following sections for choosingn between robust and classical estimators.  

```{r,results="hide",echo=F,warning=F}
geodata<-as.geodata(cbind(ussoils[,c(2,3)],log_Se))
v_classic<-variog(geodata,max.dist = 20)
v_robust<-variog(geodata, max.dist=20,estimator.type="modulus")
plot(v_classic,main = "Classical Estimator")
plot(v_classic,main = "Robust Estimator")

cloud_classic <- variog(geodata,max.dist=20,option = "cloud")
cloud_robust <- variog(geodata,estimator.type="modulus", max.dist=20,option = "cloud")
par(mfrow=c(2,2))
plot(cloud_classic, main="classical estimator")
plot(cloud_robust, main = "robust estimator")
plot(variog(geodata, bin.cloud=T, max.dist=20), bin.cloud=T)
plot(variog(geodata, bin.cloud=T, estimator.type="modulus", max.dist=20), bin.cloud=T)
```

Directional semivariograms are also presented. The following plots include a directional variogram with dir = 30 degrees, a directional variogram with dir = 60 degrees, and four directional variograms in north-south, northeast-southwest, east-west, and northwest-southeast directions.  

```{r,results="hide",echo=F,warning=F}
par(mfrow=c(1,2))
v_30 <- variog(geodata, dir=30*pi/180, max.dist=20)
plot(v_30, main = "dir = 30 degrees")
v_60 <- variog(geodata, dir=60*pi/180, max.dist=20)
plot(v_60, main = "dir = 60 degrees")

v_4dir <- variog4(geodata, max.dist=20)
plot(v_4dir, main = "dir = 0, 45, 90, 135 degrees")
```


There are various methods and models to choose from when fitting a sample semivariogram. In this part, an exponential model with default weights and robust estimator, an exponential model with Cressie's weights and robust estimator, a spherical model with default weights and classical estimator, and a spherical model with cressie's weights and classical estimator are being tested. Cross validation is used to make choices.  

```{r,results="hide",echo=F,warning=F}
fit_exp<-variofit(v_robust,cov.model = "exp",ini.cov.pars = c(0.1,10),
                   fix.nugget = F, nugget = 0.35)
fit_exp_cressie<-variofit(v_robust,cov.model = "exp",ini.cov.pars = c(0.1,10),
                   fix.nugget = F, nugget = 0.35, weights = "cressie")
fit_sph<-variofit(v_classic,cov.model = "sph",ini.cov.pars = c(0.1,10),
                   fix.nugget = F, nugget = 0.35)
fit_sph_cressie<-variofit(v_classic,cov.model = "exp",ini.cov.pars = c(0.1,10),
                   fix.nugget = F, nugget = 0.35, weights = "cressie")

plot(v_classic, main = "Omnidirectional Variogram")
lines(fit_exp,col=2)
lines(fit_exp_cressie,col=3)
lines(fit_sph,col=4)
lines(fit_sph_cressie,col=5)
legend("bottomright",
       legend=c("exp and default weights","exp and Cressie's weights",
                "sph","sph and Cressie's weights"),col=2:5,lty=1,cex=0.6,box.lty = 0)


cv_exp <- xvalid(geodata, model=fit_exp)
cv_exp_cressie <- xvalid(geodata, model=fit_exp_cressie)
cv_sph <- xvalid(geodata, model=fit_sph)
cv_sph_cressie <- xvalid(geodata, model=fit_sph_cressie)

dif_exp <- log(ussoils$Se_ppm) - cv_exp$predicted
dif_exp_cressie <- log(ussoils$Se_ppm) - cv_exp_cressie$predicted
dif_sph <- log(ussoils$Se_ppm) - cv_sph$predicted
dif_sph_cressie <- log(ussoils$Se_ppm) - cv_exp_cressie$predicted
paste("PRESS of exponential model is:",sum(dif_exp^2)) 
paste("PRESS of exponential model using cressie's weights is:",sum(dif_exp_cressie^2))
paste("PRESS of spherical model is:",sum(dif_sph^2)) 
sum(dif_sph_cressie^2)
```
The spherical model with default weights and classical estimator gives the lowest PRESS = 206.61, while the first model gives 207.07, the second gives 207.09, and the fourth gives 207.09. Then in the following spatial prediction, we will use the spherical model with default weights and classical estimator.  


## 4. Spatial Prediction
In this section, the spherical model from section 3.2 and krigings are used for spatial prediction.

### 4.1 Ordinary, Universal, and Cokriging
There are diverse ways to do kriging predictions. Three common methods are ordinary kriging, universal kriging, and cokriging. In cokriging, Cu_ppm and Zr_ppm are added as addtional variables for prediction. These three methods are compared based on cross validation.  

```{r,results="hide",echo=F,warning=F}
g_ok<-gstat(id="log_Se",formula =log(Se_ppm)~1,
            locations=~Longitude+Latitude,data=ussoils)
fit_ok<-fit.variogram(variogram(g_ok), vgm(0.1,"Sph",10,0.35))
g_uk<-gstat(id="log_Se",formula =log(Se_ppm)~Longitude+Latitude,
            locations=~Longitude+Latitude,data=ussoils)
fit_uk<-fit.variogram(variogram(g_uk), vgm(0.1,"Sph",10,0.35))
g_co<-gstat(id="log_Se",formula =log(Se_ppm)~1,
            locations=~Longitude+Latitude,data=ussoils)
g_co<-gstat(g_co,id="log_Cu",formula =log(Cu_ppm)~1,
            locations=~Longitude+Latitude,data=ussoils)
g_co<-gstat(g_co,id="log_Ba",formula =log(Ba_ppm)~1,
            locations=~Longitude+Latitude,data=ussoils)
fit_co<-fit.lmc(variogram(g_co),g_co,vgm(0.1,"Sph",10,0.35))

plot(variogram(g_ok),fit_ok, main = "ordinary kriging")
plot(variogram(g_uk),fit_uk,main = "universal kriging")
plot(variogram(g_co),fit_co,main="cokriging")

cv_ok<- krige.cv(log(Se_ppm)~1,data=ussoils, locations=~Longitude+Latitude,
                 model=fit_ok,nfold=nrow(ussoils))
cv_uk<- krige.cv(log(Se_ppm)~Longitude+Latitude,data=ussoils,
                 locations=~Longitude+Latitude, model=fit_uk,nfold=nrow(ussoils))
cv_co <- gstat.cv(fit_co,nfold = nrow(ussoils))
 
paste("PRESS of ordinary kriging is:",sum(cv_ok$residual^2)/nrow(ussoils)) 
paste("PRESS of universal kriging is:",sum(cv_uk$residual^2)/nrow(ussoils)) 
paste("PRESS of cokriging is:",sum(cv_co$residual^2)/nrow(ussoils)) 
```

The PRESS of ordinary kriging is 0.4142, the PRESS of universal kriging is 0.4139, and the PRESS of cokriging is 0.3944. Cokriging provides the least PRESS and becomes a good choice for the following prediction.  


### 4.2 Co-Kriging Prediction
In this section, a grid with by=1 is created for the predictions. Raster maps of the predicted values and variances are constructed.The raster map of the predicted values with coutours tells that locations with longitude between -100 to -80 and latitude between 30 to 40 have higher log Se concentration values. The values decrease from this center to the outside.  

```{r,results="hide",echo=F,warning=F}
x.range <- as.integer(range(ussoils[,2]))
y.range <- as.integer(range(ussoils[,3]))
grd <- expand.grid(Longitude=seq(from=x.range[1], to=x.range[2], by=1),
                   Latitude=seq(from=y.range[1], to=y.range[2], by=1))

pr_ck <- predict(fit_co,grd)
pred_table <- matrix(pr_ck$log_Se.pred,
              length(seq(from=x.range[1], to=x.range[2], by=1)),
              length(seq(from=y.range[1], to=y.range[2], by=1)))

image(seq(from=x.range[1], to=x.range[2], by=1),
       seq(from=y.range[1], to=y.range[2], by=1), pred_table,
       xlab="Longitude", ylab="Latitude", 
       main="Raster map of the Predicted Values")
contour(seq(from=x.range[1], to=x.range[2], by=1), 
        seq(from=y.range[1],to=y.range[2], by=1), pred_table, add=TRUE, labcex=1)
points(cbind(ussoils$Longitude,ussoils$Latitude))

var_table <- matrix(pr_ck$log_Se.var,
              length(seq(from=x.range[1], to=x.range[2], by=1)),
              length(seq(from=y.range[1], to=y.range[2], by=1)))
image(seq(from=x.range[1], to=x.range[2], by=1),
      seq(from=y.range[1], to=y.range[2], by=1), var_table,
      xlab="Longitude", ylab="Latitude", 
      main="Raster map of Variances")
contour(seq(from=x.range[1], to=x.range[2], by=1), 
        seq(from=y.range[1],to=y.range[2], by=1), var_table, add=TRUE,
        col="black",labcex=1)
```


## 5. Conclusion 
In this project, exploratory analysis, spatial analysis, and spatial predictions are performed on the ussoils dataset. Se_ppm is the target variable and a log transformation is taken to normalize it. The plots of robust and classical estimators are presented. A spherical model with default weights and classical estimators is chosen for making prediction because it has the smallest PRESS by cross validation. For the same reason, co-kriging with log(Cu_ppm) and log(Ba_ppm) is chosen. Finally, a grid is constructed for prediction and raster maps are presented to show the results.   